### Logback 사용하기 

#### 특징

- 오랫동안 널리 사용되고 검증된 Log4j 를 기반으로 다시 작성됨.

- 로그 설정이 변경될 경우 서버를 재시작하지 않더라도 바로 반영됨.

- slf4j 를 함께 사용함. (자바의 다양한 로그 모듈들의 추상체)

- src/main/resources 폴더에 logback-spring.xml 파일 생성및 작성

- 사용하는 로그 레벨 

  | 로그레벨 | 설명                                                         |
  | -------- | ------------------------------------------------------------ |
  | trace    | 모든 로그를 출력함.                                          |
  | debug    | 개발시 디버그 용도로 사용.                                   |
  | info     | 상태 변경 등 정보성 메세지 나타냄.                           |
  | warn     | 프로그램의 실행에는 문제가 없지만 추후 시스템 에러의 원인이 될 수 있다는 경고성 메세지 의미함. |
  | error    | 요청을 처리하던 중 문제가 발생.                              |

- 로그를 사용하려는 클래스에서 로거 생성

  getlogger 메서드의 파라미터 : 로거의 이름 설정 

  `Logger log = LoggerFactory.getLogger(this.getClass());`



### Log4JDBC로 쿼리 로그 정렬하기 

- 앞에서 사용하는 로그들은 개발하는데 당장 필요하지 않은 정보가 많음. 또한 정렬되어 있지 않아 로그 한눈에 알아보기 힘듬. 
- 긴 쿼리들도 한줄에 나와서 한눈에 파악하기 힘들다. 
- 위와 같은 이유들로 Log4JDBC 라이브러리 사용함. 

#### 라이브러리 추가하기 

- build.gradle 파일에 추가 

#### log4jdbc 설정하기 

- log4jdbc.log4j2.properties 설정 
- application.properties 설정 
- logback-spring.xml 설정 : 쿼리 및 실행 결과를 보여주는 로거 추가 
  - sqlonly 와 resulttable 로거 사용 



### 인터셉터 사용하기

- 어떠한 URI를 호출했을 때 해당 요청의 컨트롤러가 처리되기 전 또는 후에 작업을 하기 위해서 사용됨.  --> 필터와 인터셉터가 이 역할을 수행 
- ![1563776524044](C:\Users\bsww201\AppData\Roaming\Typora\typora-user-images\1563776524044.png)

- 필터는 서블릿의 기능 중 일부.
- 인터셉터는 스프링 프레임워크에서 제공되는 기능. 스프링 Bean을 사용할 수 있음. 

#### HandlerInterceptorAdaptor로 인터셉터 구현하기 

- 스프링에서 인터셉터는 HandlerInterceptorAdaptor 클래스를 상속받아 구현. 

- | 메서드          | 역할                                             |
  | --------------- | ------------------------------------------------ |
  | preHandle       | 컨트롤러 실행전에 수행됨.                        |
  | postHandle      | 컨트롤러 실행 후 결과를 뷰로 보내기 전에 수행됨. |
  | afterCompletion | 뷰의 작업까지 완료된 후 수행됨.                  |



#### Interceptor 등록하기 

- 스프링 빈으로 등록하기 



### AOP 사용하기 

- Aspect Oriented Programming  = 관점 지향 프로그래밍 

- AOP는 OOP를 더욱 OOP갑게 사용하도록 도와주는 개념 

  - 공통기능을 구현하기 위해 다시 다른 객체의 기능이 필요하다거나, 객체에서 다른 객체를 계속 호출해야 하는 등 객체 간 종속성이 강한 경우가 있음 --> AOP를 이용하면 다른 객체의 호출과 상관없이 각각의 기능에만 집중해서 모듈로 만들 수 있음. --> **AOP는 비즈니스 로직을 구현한 코드에서 공통 기능 코드를 직접 호출하지 않음**

- 객체지향 : 관심사가 같은 기능과 데이터를 모아서 재사용이 가능한 객체로 캡슐화하는 것을 의미한다. 

- AOP는 애플리케이션 전반에서 사용되는 기능을 여러코드에 쉽게 적용할 수 있도록 한다. 

- 관점 지향 --> 대상을 바라보는 방향을 바꾸자는 의미. 

  - 예를 들어, 계정,게시판, 계좌이체라는 핵심 기능의 관점에서는 권한, 로깅, 트랜잭션 등 부가기능 사이에 공통점이 없음.
  - 그러나, 부가기능의 관점에서는 핵심로직이 어떤 역할하는지 알 필요 없음. 부가 기능이 적용될 시점에서 부가 기능이 적용되기만 하면 됨. 

- 관련 용어 정리 

- | 용어      | 의미                                                         |
  | --------- | ------------------------------------------------------------ |
  | Aspect    | 공통적으로 적용될 기능을 의미. 한개 이상의 포인트 컷과 어드바이스의 조합으로 만들어짐. |
  | Advice    | Aspect의 구현체로 조인포인트에 삽입되어 동작하는 것을 의미. 스프링에서 사용하는 어드바이스는 동작하는 시점에 따라 5종류로 구분됨. |
  | Joinpoint | 어드바이스를 적용하는 시점. 스프링 프레임워크에서 조인포인트는 항상 메서드 실행단계만 가능. |
  | Pointcut  | 어드바이스를 적용할 조인포인트를 선별하는 과정이나 그 기능을 정의한 모듈을 의미. 정규표현식이나 AspectJ의 문법을 이용해 어떤 조인포인트를 사용할 것인지 결정함. |
  | Target    | 어드바이스 받을 대상을 의미.                                 |
  | Weaving   | 어드바이스를 적용하는 것을 의미. 공통 코드를 원하는 대상에 삽입하는 것을 뜻함. |



#### AOP 적용하기 

- 로그 출력에 적용해 볼 것 (컨트롤러, 서비스, 매퍼의 메서드가 실행될 때 메서드의 경로와 이름)
- **@Aspect** : 자바코드에서 AOP 설정 
- **@Around** : 해당기능이 실행될 시점. 어드바이스 정의. 
  - `@Around("excution(* board..controller.*Controller.*(..)) or excution(* board..service.*Impl.*(..)) or excution(* board..dao.*Mapper.*(..))")`

- AOP는 모든 로직에 적용할 공통기능을 외부에서 삽입할 수 있다. 
  - 공통적으로 적용할 로그 기능인 LoggerAspect 라는 외부클래스를 정의하고 애플리케이션의 실행시점에 기능이 삽입되어 실행됨. 
  - 각각의 aspect를 분리하고 기존 로직의 변화 없이 원하는 시점에 코드 삽입 가능 



#### 트랜잭션 적용하기 

- 대용량의 데이터 처리하기 위해 엄격한 트랜잭션 적용하지 않음.
- xml로 트랜잭션 처리하는 방식, 어노테이션으로 처리하는 방식, AOP를 사용해 처리하는 방식
- 트랜잭션? 
  - 데이터베이스의 상태를 변화시킬 때 더 이상 분리할 수 없는 작은 일련의 과정들이 분리되면 안된다. --> 하나의 트랜잭션에서 일련의 작업이 처리되어야 한다. 
  - ACID 속성 중 원자성과 가장 관련됨.
  - 트랜잭션 내의 다양한 과정 중 하나라도 실패할 경우 전체과정을 모두 취소하고 트랜잭션이 시작하기 전 상태로 돌림. (rollback)

1. **@Transaction** 어노테이션으로 트랜잭션 설정 
   - 설정전에 스프링에서 제공하는 어노테이션 기반 트랜잭션 활성화를 해주고 스프링이 제공하는 트랜잭션 매니저를 등록하는 과정을 database config 클래스에 해준다. 
   - 그 후 트랜잭션을 처리하기 원하는 곳에 해당 어노테이션 추가하는 것
   - 특별한 설정없이 쉽게 사용가능 
   - 외부 라이브러리에 적용 불가능 
2. **AOP** 로 트랜잭션 설정
   - 1번 처럼 하게 될 경우 적용대상이 많아지면 어노테이션이 누락되거나 일관되지 않게 적용될 수 있음. --> 이러한 문제 해결위해 AOP 사용
   - 외부 라이브러리에 적용 가능
   - 원하는 곳에만 트랜잭션 적용하기 어려움. 